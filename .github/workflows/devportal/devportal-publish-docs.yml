name: Publish Docs to Algorand Developer Portal

on:
  workflow_call:
    inputs:
      docs_path:
        description: "Location relative to the repo root of the docs folder"
        type: string
        required: false
        default: "docs"
      docs_branch:
        description: "Name of the branch to publish the docs to"
        type: string
        required: false
        default: "docs-dist"

jobs:
  publish-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate manifest.json
        run: node devportal/scripts/generate-manifest.mjs "${{ inputs.docs_path }}" "${{ github.repository }}" "${{ github.sha }}"

      - name: Determine docs target
        id: docs_target
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            tag="${{ github.event.release.tag_name }}"
            if [[ -z "$tag" ]]; then
              echo "Release event missing tag_name" >&2
              exit 1
            fi
            # Strip leading 'v' if present to get clean version
            version="${tag#v}"
            target="v${version}"
            update_latest="true"
          else
            target="latest"
            update_latest="false"
          fi
          echo "target=$target" >> "$GITHUB_OUTPUT"
          echo "update_latest=$update_latest" >> "$GITHUB_OUTPUT"
          echo "Publishing to: $target (update_latest: $update_latest)"

      - name: Checkout docs branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.docs_branch }}
          path: docs-branch
        continue-on-error: true

      - name: Prepare publish workspace
        run: |
          docs_path="${{ inputs.docs_path }}"
          target="${{ steps.docs_target.outputs.target }}"

          # Start with existing docs branch content (if it exists)
          if [[ -d "docs-branch" ]]; then
            rm -rf docs-branch/.git
            mv docs-branch publish-staging
          else
            mkdir -p publish-staging
          fi

          # Overwrite target version folder
          rm -rf "publish-staging/${target}"
          mkdir -p "publish-staging/${target}"
          cp -R "${docs_path}/." "publish-staging/${target}/"

          # Overwrite latest folder on release
          if [[ "${{ steps.docs_target.outputs.update_latest }}" == "true" ]]; then
            rm -rf "publish-staging/latest"
            mkdir -p "publish-staging/latest"
            cp -R "${docs_path}/." "publish-staging/latest/"
          fi

      - name: Publish docs branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: publish-staging
          publish_branch: ${{ inputs.docs_branch }}
          keep_files: false

      - name: Notify DevPortal of Documentation Update
        if: success()
        id: notify-devportal
        run: node devportal/scripts/notify-devportal.mjs && echo "devportal_notified=true" >> "$GITHUB_OUTPUT" || echo "devportal_notified=false" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_RELEASE_TAG_NAME: ${{ github.event.release.tag_name }}
          GITHUB_EVENT_RELEASE_NAME: ${{ github.event.release.name }}
          GITHUB_EVENT_RELEASE_HTML_URL: ${{ github.event.release.html_url }}
          GITHUB_EVENT_RELEASE_CREATED_AT: ${{ github.event.release.created_at }}
          GITHUB_EVENT_HEAD_COMMIT_URL: ${{ github.event.head_commit.url }}
          GITHUB_EVENT_HEAD_COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          GITHUB_EVENT_INPUTS_REASON: ${{ github.event.inputs.reason }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          DEVPORTAL_REPO: ${{ vars.DEVPORTAL_REPO || 'algorandfoundation/devportal' }}
          DOCS_BRANCH: ${{ inputs.docs_branch }}
          DEVPORTAL_DISPATCH_TOKEN: ${{ secrets.DEVPORTAL_DISPATCH_TOKEN }}
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version target**: \`${{ steps.docs_target.outputs.target || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation Branch**: \`${{ env.DOCS_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Build Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.notify-devportal.outputs.devportal_notified }}" = "true" ]; then
            echo "- **DevPortal Notification**: âœ… Sent" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ The DevPortal was notified and will import this documentation." >> $GITHUB_STEP_SUMMARY
          else
            echo "- **DevPortal Notification**: âš ï¸ Not sent" >> $GITHUB_STEP_SUMMARY
          fi
