name: "Run typedoc and publish to pages"

on:
  workflow_call:

jobs:
  # ------------------------------------------------------------------------
  # 1. ALGO-KIT DOCS BUILD
  # ------------------------------------------------------------------------
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build Typedoc Documentation
        uses: algorandfoundation/algokit-shared-config/.github/actions/generate-typescript-docs@main
      - name: Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-pages-docs
          path: docs/_html
          retention-days: 1

  # ------------------------------------------------------------------------
  # 2. ALGO-KIT GITHUB PAGES DEPLOY
  # ------------------------------------------------------------------------
  publish-docs:
    needs: build-docs
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Download Documentation Artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages-docs
          path: docs/downloaded

      - name: Deploy Documentation
        uses: algorandfoundation/algokit-shared-config/.github/actions/publish-docs@main
        with:
          artifact_path: docs/downloaded

  # ------------------------------------------------------------------------
  # 3. DEV PORTAL COORDINATION (The previously nested job, now corrected)
  # ------------------------------------------------------------------------
  devportal-update: # <--- CORRECTLY PLACED as a direct child of 'jobs:'
    needs: [build-docs, publish-docs]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for the called workflow to push to docs-dist
    steps:
      - name: Checkout Source Code (for devportal scripts)
        uses: actions/checkout@v4

      # 1. MANAGE DOCS-DIST BRANCH (Local verification only)
      - name: Call Docs Dist Publishing
        uses: ./.github/workflows/devportal/publish-docs-dist.yml
        id: publish_dist
        with:
          artifact_name: github-pages-docs
          docs_path_in_artifact: "."
          docs_branch: "docs-dist"

      # 2. MOCK NOTIFY DEVPORTAL REPO
      - name: Setup Node.js (for notification script)
        if: success() && steps.publish_dist.outputs.pushed_to_dist == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Mock DevPortal Notification
        if: success() && steps.publish_dist.outputs.pushed_to_dist == 'true'
        id: notify-devportal
        # Ensuring you use the correct script name from the latest context: notify-devportal.mjs or notify-devportal-test.mjs
        run: node devportal/scripts/notify-devportal-test.mjs
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "## Documentation Publish Summary (TEST ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
          echo "- **Docs Dist Branch Status**: ${{ steps.publish_dist.outputs.pushed_to_dist == 'true' && '✅ Updated' || '⚠️ No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DevPortal Notification**: ✅ Skipped (Running in Test Mode)" >> $GITHUB_STEP_SUMMARY
