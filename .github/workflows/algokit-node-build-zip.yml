# .github/workflows/algokit-node-build-zip.yml - FINAL REVISION
name: Generic Node.js Build and Zip

on:
  workflow_call:
    inputs:
      # ... (Inputs remain the same) ...
      node-version:
        required: false
        type: string
        default: 20.x
      working-directory:
        required: false
        type: string
        default: "."
      build-path:
        required: false
        type: string
        default: dist
      artifact-name:
        required: false
        type: string
        default: node-artifact
      static-site:
        required: false
        type: boolean
        default: false
        description: Set to true for static sites to enable build-time environment variable substitution.
      static-site-env-prefix:
        required: false
        type: string
        default: VITE
        description: Environment variable prefix.
      pre-run-script:
        required: false
        type: string
      sample-env-path:
        required: false
        type: string
        default: .env.sample
        description: Path to the .env file containing environment variable keys.
    secrets:
      npm-auth-token:
        description: Custom NPM auth token for private package access (optional).
        required: false
      # REQUIRED FIX: Explicitly define the required GITHUB_TOKEN here.
      # The caller must now pass this explicitly.
      github-token:
        description: The GITHUB_TOKEN required for checkout and package access.
        required: true # Making it required simplifies logic, but you can set to false if your org's rules allow GITHUB_TOKEN inheritance.

jobs:
  build-zip:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      # ... (Checkout and Setup Node.js steps remain the same) ...

      - name: âš™ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      # --- Authentication Setup ---

      # FIX 1: Simplify logic, use a fallback variable inside the run block.
      - name: ğŸ”‘ Configure NPM Auth (For Private Packages)
        # Check if the npm-auth-token is provided OR if the github-token is provided
        if: ${{ secrets.npm-auth-token || secrets.github-token }}
        run: |
          # Use the npm-auth-token OR the github-token passed by the caller.
          TOKEN=${{ secrets.npm-auth-token || secrets.github-token }}

          if [[ -n "$TOKEN" ]]; then
            echo "//npm.pkg.github.com/:_authToken=${TOKEN}" > .npmrc
            echo "NPM authentication configured."
          fi
        shell: bash

      # ... (Pre-run and Static Site steps remain the same) ...

      - name: â¬‡ï¸ Install Dependencies (npm ci --ignore-scripts)
        run: npm ci --ignore-scripts
        env:
          # FIX 2: Use the provided tokens with the simplified fallback logic.
          NODE_AUTH_TOKEN: ${{ secrets.npm-auth-token || secrets.github-token }}

      - name: ğŸ› ï¸ Run Post-Install Scripts (npm rebuild & prepare)
        run: npm rebuild && npm run prepare --if-present

      - name: Prepare
        run: npm run prepare --if-present

      - name: ğŸ—ï¸ Build Project
        run: npm run build
        env:
          # FIX 3: Use the provided tokens with the simplified fallback logic.
          NODE_AUTH_TOKEN: ${{ secrets.npm-auth-token || secrets.github-token }}

      - name: ğŸ—œï¸ Zip build folder
        run: pushd ${{ inputs.build-path}}; zip -q -r ../${{ inputs.artifact-name }}.zip *; popd
        shell: bash

      - name: â¬†ï¸ Upload Zipped Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.working-directory }}/${{ inputs.artifact-name }}.zip
          if-no-files-found: error
