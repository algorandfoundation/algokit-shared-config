# .github/workflows/algokit-node-build-zip.yml - SIMPLIFIED
name: Generic Node.js Build and Zip

on:
  workflow_call:
    inputs:
      # ... (Inputs remain the same) ...
      node-version:
        required: false
        type: string
        default: 20.x
      working-directory:
        required: false
        type: string
        default: "."
      build-path:
        required: false
        type: string
        default: dist
      artifact-name:
        required: false
        type: string
        default: node-artifact
      static-site:
        required: false
        type: boolean
        default: false
        description: Set to true for static sites to enable build-time environment variable substitution.
      static-site-env-prefix:
        required: false
        type: string
        default: VITE
        description: Environment variable prefix.
      pre-run-script:
        required: false
        type: string
      sample-env-path:
        required: false
        type: string
        default: .env.sample
        description: Path to the .env file containing environment variable keys.
    secrets:
      npm-auth-token:
        description: Custom NPM auth token for private package access.
        required: true # Now required
      github-token:
        description: The GITHUB_TOKEN required for checkout and GitHub package access.
        required: true # Now required

jobs:
  build-zip:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.working-directory }}

    steps:
      # Use the github-token for private repository checkout
      - name: âš™ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.github-token }}

      - name: ğŸŸ¢ Set up Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "npm"
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      # --- Authentication Setup: Simplified to use only the dedicated NPM token ---

      - name: ğŸ”‘ Configure NPM Auth (For Private Packages)
        run: |
          # Use the dedicated NPM token
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.npm-auth-token }}" > .npmrc
        shell: bash

      # --- Pre-Build Steps (no change) ---

      - name: ğŸ”¨ Pre-run Script (Optional)
        if: ${{ inputs.pre-run-script }}
        run: ${{ inputs.pre-run-script }}

      - name: ğŸŒ Prepare Static Site Config Transformation
        if: ${{ inputs.static-site }}
        run: |
          sed -n 's/\(${{ inputs.static-site-env-prefix }}_[A-Z0-9_]\+\)=\(.*\)/\1={{\1}}/p' ${{ inputs.sample-env-path }} > .env && cat .env
        shell: bash

      # --- Dependency Installation (Simplified env) ---

      - name: â¬‡ï¸ Install Dependencies (npm ci --ignore-scripts)
        run: npm ci --ignore-scripts
        env:
          # Use only the dedicated NPM auth token
          NODE_AUTH_TOKEN: ${{ secrets.npm-auth-token }}

      - name: ğŸ› ï¸ Run Post-Install Scripts (npm rebuild & prepare)
        run: npm rebuild && npm run prepare --if-present

      - name: Prepare
        run: npm run prepare --if-present

      - name: ğŸ—ï¸ Build Project
        run: npm run build
        env:
          # Use only the dedicated NPM auth token
          NODE_AUTH_TOKEN: ${{ secrets.npm-auth-token }}

      # --- Artifact Creation and Upload (no change) ---

      - name: ğŸ—œï¸ Zip build folder
        run: pushd ${{ inputs.build-path}}; zip -q -r ../${{ inputs.artifact-name }}.zip *; popd
        shell: bash

      - name: â¬†ï¸ Upload Zipped Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.working-directory }}/${{ inputs.artifact-name }}.zip
          if-no-files-found: error
