name: Publish Docs to Algorand Developer Portal
description: Publishes documentation to a dedicated docs branch for consumption by the Developer Portal

inputs:
  docs_path:
    description: "Location relative to the repo root of the docs folder"
    required: false
    default: ".devportal"
  docs_branch:
    description: "Name of the branch to publish the docs to"
    required: false
    default: "docs-dist"
  github_token:
    description: "GitHub token for publishing to docs branch"
    required: true

outputs:
  docs_target:
    description: "The version target that was published (e.g., 'latest' or 'v1.2.3')"
    value: ${{ steps.docs_target.outputs.target }}

runs:
  using: composite
  steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x

    - name: Install dependencies
      run: npm ci
      shell: bash

    - name: Setup typedoc configuration
      shell: bash
      run: node "${{ github.action_path }}/typedoc-config.js"

    - name: Build docs
      shell: bash
      run: npx typedoc --options typedoc.devportal.json

    - name: Generate manifest
      shell: bash
      run: node "${{ github.action_path }}/generate-manifest.mjs" "${{ inputs.docs_path }}" "${{ github.repository }}" "${{ github.sha }}"

    - name: Determine docs target
      id: docs_target
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          tag="${{ github.event.release.tag_name }}"
          if [[ -z "$tag" ]]; then
            echo "Release event missing tag_name" >&2
            exit 1
          fi
          # Strip leading 'v' if present to get clean version
          version="${tag#v}"
          target="v${version}"
        else
          target="latest"
        fi
        echo "target=$target" >> "$GITHUB_OUTPUT"
        echo "Publishing to: $target"

    - name: Publish docs to target version
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ inputs.github_token }}
        publish_dir: ${{ inputs.docs_path }}
        publish_branch: ${{ inputs.docs_branch }}
        destination_dir: ${{ steps.docs_target.outputs.target }}
        keep_files: true

    - name: Publish docs to latest (on release)
      if: github.event_name == 'release'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ inputs.github_token }}
        publish_dir: ${{ inputs.docs_path }}
        publish_branch: ${{ inputs.docs_branch }}
        destination_dir: latest
        keep_files: true

    - name: Summary
      if: always()
      shell: bash
      run: |
        echo "## Documentation Publish Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Version target**: \`${{ steps.docs_target.outputs.target || 'latest' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation Branch**: \`${{ inputs.docs_branch }}\`" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Build Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ Documentation published successfully. The DevPortal will sync these changes during its next nightly update." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Need immediate update?** Navigate to the DevPortal repository Actions tab and manually trigger the documentation import workflow." >> $GITHUB_STEP_SUMMARY
